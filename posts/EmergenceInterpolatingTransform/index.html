<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Emergence: Interpolating transform" /><meta property="og:locale" content="en" /><meta name="description" content="What if I say that every game object in Emergence has two transforms? What for? For the sake of making everything look cool, of course! In this post I will describe transform interpolation, which is quite useful feature unless you’re entirely sure that variable framerate is the best option for you." /><meta property="og:description" content="What if I say that every game object in Emergence has two transforms? What for? For the sake of making everything look cool, of course! In this post I will describe transform interpolation, which is quite useful feature unless you’re entirely sure that variable framerate is the best option for you." /><link rel="canonical" href="/posts/EmergenceInterpolatingTransform/" /><meta property="og:url" content="/posts/EmergenceInterpolatingTransform/" /><meta property="og:site_name" content="WHAT KIND OF DEV ARE YOU" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-27T20:30:00+03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Emergence: Interpolating transform" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-06-27T20:45:05+03:00","datePublished":"2022-06-27T20:30:00+03:00","description":"What if I say that every game object in Emergence has two transforms? What for? For the sake of making everything look cool, of course! In this post I will describe transform interpolation, which is quite useful feature unless you’re entirely sure that variable framerate is the best option for you.","headline":"Emergence: Interpolating transform","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/EmergenceInterpolatingTransform/"},"url":"/posts/EmergenceInterpolatingTransform/"}</script><title>Emergence: Interpolating transform | WHAT KIND OF DEV ARE YOU</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="WHAT KIND OF DEV ARE YOU"><meta name="application-name" content="WHAT KIND OF DEV ARE YOU"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">WHAT KIND OF DEV ARE YOU</a></div><div class="site-subtitle font-italic">Personal blog above Game Development and related things</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/KonstantinTomashevich" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://t.me/WhatKindOfDevAreYou" aria-label="telegram" target="_blank" rel="noopener"> <i class="fab fa-telegram"></i> </a> <a href="https://t.me/KonstantinTomashevich" aria-label="telegram" target="_blank" rel="noopener"> <i class="fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/in/konstantin-tomashevich-1881aa152/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Emergence: Interpolating transform</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Emergence: Interpolating transform</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1656351000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 27, 2022 </em> </span> <span> Updated <em class="" data-ts="1656351905" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 27, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/KonstantinTomashevich">Konstantin Tomashevich</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1490 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><p>What if I say that every game object in Emergence has two transforms? What for? For the sake of making everything look cool, of course! In this post I will describe transform interpolation, which is quite useful feature unless you’re entirely sure that variable framerate is the best option for you.</p><h3 id="framerate-and-world-updates"><span class="mr-2">Framerate and world updates</span><a href="#framerate-and-world-updates" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>There is a perfect <a href="https://gafferongames.com/post/fix_your_timestep/">article about time steps by Glenn Fiedler</a>. But just sending you to the other blog wouldn’t be polite, so I’ll write my view on this topic too.</p><p>By far the simpliest approach to update game world is to execute it before every render and passing frame delta time as time step. Despite being primitive, it is widely adopted and even used in Unreal Engine! But there is a one not-so-simple problem with this approach: it makes your simulation non-deterministic, because time step is equal to frame time delta and therefore is hardware-dependent. And this problem triggers a bunch of smaller problems: physics simulation might be buggy and strange, multiplayer networking is difficult because of non-determinism, subtle and hard to figure out gameplay bugs (or features! :) ) may arise.</p><p>The other option is fixed+normal updates approach: physics simulation, networking and “strong” gameplay logic are updated with fixed time steps using time accumulation, while render and visual logic are updated using variable framerate technique from previous paragraph. This allows to both have deterministic simulation of features that work in fixed update, and responsive visual that works in normal update. It might sound like a miraculous solution, but there is a reason why it is not as widely adopted as simple variable framerate: it is more difficult to work with two separate update pipelines than with one. For example, it creates problem of transform interpolation: transforms are updated in fixed pipeline, but we would like to see smooth movement instead of jittery transform changes. And it is exactly the theme of this post!</p><p>For those who have read <a href="https://gafferongames.com/post/fix_your_timestep/">Glenn’s article</a>, I would like to highlight that <a href="https://github.com/KonstantinTomashevich/Emergence/tree/72ff166/Library/Public/Celerity">Celerity</a> treats time accumulation in a bit different way. In Glenn’s version normal update “produces” time and fixed update “consumes” time, but in my library I’ve decided to take inversed approach: fixed update “produces” time and normal update “consumes” it. The reason for this is that real time is always way ahead of render time if article version is used:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>----F----F--R-F--T-|----|----
F -- executed fixed updates.
R -- render time.
T -- real time.
| -- planned fixed update.
</pre></table></code></div></div><p>After inversion fixed updates are ahead of real time, but render time is equal to real time:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>----F----F----F--T-F----|----
</pre></table></code></div></div><p>Nevertheless, from perspective of input both variants have 1 frame latency, therefore difference is not so big and you’re free to use any variant.</p><h3 id="no-interpolation-vs-interpolation"><span class="mr-2">No interpolation vs Interpolation</span><a href="#no-interpolation-vs-interpolation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Let’s imagine that we directly use transforms from fixed update to render our objects. At 60 FPS everything probably looks superb. But then designers introduce slowdown feature, that allows player to run game at x0.25 speed for several seconds. Suddenly, during slowdown everything starts looking jittery:</p><p><img data-src="/assets/img/EmergenceInterpolatingTransform/NoInterpolation.gif" alt="NoInterpolation.gif" data-proofer-ignore></p><p>But we don’t want player to think that game lags during slowdown! We want something smoother, like this:</p><p><img data-src="/assets/img/EmergenceInterpolatingTransform/Interpolation.gif" alt="Interpolation.gif" data-proofer-ignore></p><p>To achieve smoothier picture we need to adapt to the situation and use different transforms for render. And that is exactly how visual transform interpolation works: we adjust render transforms and everything looks like miracle!</p><h3 id="interpolation-use-cases"><span class="mr-2">Interpolation use cases</span><a href="#interpolation-use-cases" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Some rare slowdown feature is not the only case where you need interpolation. There are many more other cases, for example:</p><ul><li><p>Sometimes users might like to watch the game at much higher framerate that we could possibly achieve by doing 1 normal update per 1 fixed update. I don’t really see the difference between 60 and 120 FPS, but some people do. For these people we need to render several frames per fixed update and interpolate transforms.</p><li><p>Sometimes fixed update might drastically slow down game performance, for example when doing difficult dynamics calculations. It might even result in death spiral: it is when we are doing more and more fixed updates each frame because frame time is bigger than fixed step time. To solve this issue we need to temporarily increase fixed time step, for example from 60 FPS to 15 FPS (yeah, technically we’re increasing it, because time step value increases), and to keep visual effects clean while doing so we need to interpolate.</p><li><p>Multiplayer games usually have low replication frequency to optimize traffic usage. For example, Apex Legends sends replication data at 20 samples per second. Of course, it would have looked laggy without interpolation!</p></ul><h3 id="interpolation-in-celerity"><span class="mr-2">Interpolation in Celerity</span><a href="#interpolation-in-celerity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now it’s finally time to tell how I implemented interpolation in <a href="https://github.com/KonstantinTomashevich/Emergence/tree/72ff166/Library/Public/Celerity">Celerity</a>!</p><p>Let’s start from the concept of interpolated movement: we need to enable interpolation only when object actually moves, otherwise we will not only spend CPU time on useless work, but could also see incorrect results: for example, we can interpolate teleportation or interpolate spawn by moving object from world zero to spawn transform. To achieve that we need to use special flag inside <code class="language-plaintext highlighter-rouge">Transform3dComponent</code> that I called <code class="language-plaintext highlighter-rouge">visualTransformSyncNeeded</code>. This flag is true only when object is in interpolated movement mode and always false otherwise. For spawns and teleports there is special a <code class="language-plaintext highlighter-rouge">_skipInterpolation</code> parameter in transform setter, that allows to move objects without enabling <code class="language-plaintext highlighter-rouge">visualTransformSyncNeeded</code>. That’s how logical transform setter code looks like:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">Transform3dComponent</span><span class="o">::</span><span class="n">SetLogicalLocalTransform</span> <span class="p">(</span><span class="k">const</span> <span class="n">Math</span><span class="o">::</span><span class="n">Transform3d</span> <span class="o">&amp;</span><span class="n">_transform</span><span class="p">,</span>
                                                     <span class="kt">bool</span> <span class="n">_skipInterpolation</span><span class="p">)</span> <span class="k">noexcept</span>
<span class="p">{</span>
    <span class="c1">// ... Irrelevant setter logic ...</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_skipInterpolation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// We do not enable interpolation, therefore we need to set visual transform directly.</span>
        <span class="n">SetVisualLocalTransform</span> <span class="p">(</span><span class="n">logicalLocalTransform</span><span class="p">);</span>

        <span class="c1">// If object was in interpoolated movement mode -- interrupt it.</span>
        <span class="n">visualTransformSyncNeeded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">// If we're not in interpolated movement mode, we need to reset sync timer </span>
        <span class="c1">// to correctly process pauses between two different interpolated movements. </span>
        <span class="c1">// Otherwise, interpolation result would be incorrect.</span>
        <span class="c1">// More about that timer below.</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">visualTransformSyncNeeded</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">visualTransformLastSyncTimeNs</span> <span class="o">=</span> <span class="mi">0u</span><span class="p">;</span>
            <span class="n">visualTransformSyncNeeded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>To apply interpolation we need to know 2 time stamps:</p><ol><li><p>Last fixed timestamp when logical transform was changed.</p><li><p>Last normal time stamp during which visual transform had desired value.</p></ol><p>Getting first one is pretty easy: we need to save it as variable inside transform and update it during interpolated movement whenever we detect that transform was changed, like this:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c1">// Celerity uses revision-driven transform change detection instead of dirty flags, </span>
<span class="c1">// because it allows to avoid going through full hierarchy when transform is setted.</span>
<span class="k">if</span> <span class="p">(</span><span class="n">transform</span><span class="o">-&gt;</span><span class="n">lastObservedLogicalTransformRevision</span> <span class="o">!=</span> <span class="n">transform</span><span class="o">-&gt;</span><span class="n">logicalLocalTransformRevision</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">transform</span><span class="o">-&gt;</span><span class="n">lastObservedLogicalTransformRevision</span> <span class="o">=</span> <span class="n">transform</span><span class="o">-&gt;</span><span class="n">logicalLocalTransformRevision</span><span class="p">;</span>

    <span class="c1">// We've detected transform change and now can save required timestamp.</span>
    <span class="n">transform</span><span class="o">-&gt;</span><span class="n">logicalTransformLastObservationTimeNs</span> <span class="o">=</span> <span class="n">time</span><span class="o">-&gt;</span><span class="n">fixedTimeNs</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Getting second one is more difficult at first glance, but actually it is easy too. After each interpolation operation visual transform has desired value, therefore during interpolated movement second timestamp is always equal to the normal time of previous frame. But what about first frame of interpolated movement? Because movement has just started, object is already in desired transform, therefore time stamp is equal to frame normal time. Code looks like this:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c1">// Interpolated movement detected. Remember setter code above? </span>
<span class="c1">// Yep, that's why we set it to zero there.</span>
<span class="k">if</span> <span class="p">(</span><span class="n">transform</span><span class="o">-&gt;</span><span class="n">visualTransformLastSyncTimeNs</span> <span class="o">==</span> <span class="mi">0u</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">transform</span><span class="o">-&gt;</span><span class="n">visualTransformLastSyncTimeNs</span> <span class="o">=</span> <span class="n">time</span><span class="o">-&gt;</span><span class="n">normalTimeNs</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ... Actual interpolation execution ...</span>

<span class="n">transform</span><span class="o">-&gt;</span><span class="n">visualTransformLastSyncTimeNs</span> <span class="o">=</span> <span class="n">time</span><span class="o">-&gt;</span><span class="n">normalTimeNs</span><span class="p">;</span>
</pre></table></code></div></div><p>This two time stamps are our interpolation borders and current normal time is point at which we need to calculate transform. Now we have enough information to do transform linear interpolation:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">// Time elapsed since last disered visual transform.</span>
<span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">-&gt;</span><span class="n">normalTimeNs</span> <span class="o">-</span> 
                         <span class="n">transform</span><span class="o">-&gt;</span><span class="n">visualTransformLastSyncTimeNs</span><span class="p">;</span>

<span class="c1">// Known interpolation interval duration.</span>
<span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">transform</span><span class="o">-&gt;</span><span class="n">logicalTransformLastObservationTimeNs</span> <span class="o">-</span> 
                          <span class="n">transform</span><span class="o">-&gt;</span><span class="n">visualTransformLastSyncTimeNs</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">float</span> <span class="n">progress</span> <span class="o">=</span> <span class="n">Math</span><span class="o">::</span><span class="n">Clamp</span> <span class="p">(</span>
    <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">elapsed</span><span class="p">)</span> <span class="o">/</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">duration</span><span class="p">),</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">,</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">);</span>

<span class="c1">// Note, that we are only working with local transforms here: </span>
<span class="c1">// we don't need to take global ones into account because</span>
<span class="c1">// we're processing every transform that needs interpolation,</span>
<span class="c1">// so if parent transform was changed, it would be processed separately.</span>
<span class="k">const</span> <span class="n">Math</span><span class="o">::</span><span class="n">Transform3d</span> <span class="o">&amp;</span><span class="n">source</span> <span class="o">=</span> <span class="n">transform</span><span class="o">-&gt;</span><span class="n">GetVisualLocalTransform</span> <span class="p">();</span>
<span class="k">const</span> <span class="n">Math</span><span class="o">::</span><span class="n">Transform3d</span> <span class="o">&amp;</span><span class="n">target</span> <span class="o">=</span> <span class="n">transform</span><span class="o">-&gt;</span><span class="n">GetLogicalLocalTransform</span> <span class="p">();</span>

<span class="n">transform</span><span class="o">-&gt;</span><span class="n">SetVisualLocalTransform</span> <span class="p">({</span><span class="n">Math</span><span class="o">::</span><span class="n">Lerp</span> <span class="p">(</span><span class="n">source</span><span class="p">.</span><span class="n">translation</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="n">translation</span><span class="p">,</span> <span class="n">progress</span><span class="p">),</span>
                                     <span class="n">Math</span><span class="o">::</span><span class="n">SLerp</span> <span class="p">(</span><span class="n">source</span><span class="p">.</span><span class="n">rotation</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="n">rotation</span><span class="p">,</span> <span class="n">progress</span><span class="p">),</span>
                                     <span class="n">Math</span><span class="o">::</span><span class="n">Lerp</span> <span class="p">(</span><span class="n">source</span><span class="p">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">progress</span><span class="p">)});</span>
</pre></table></code></div></div><p>Simple and straighforward, isn’t it? There is only one last detail left: we need to exit from interpolated movement mode after arriving at target destination. It is easier than it sounds:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">transform</span><span class="o">-&gt;</span><span class="n">visualTransformSyncNeeded</span> <span class="o">=</span>
    <span class="n">transform</span><span class="o">-&gt;</span><span class="n">visualTransformLastSyncTimeNs</span> <span class="o">&lt;</span> <span class="n">transform</span><span class="o">-&gt;</span><span class="n">logicalTransformLastObservationTimeNs</span><span class="p">;</span>
</pre></table></code></div></div><p>And that’s all! Transform interpolation might sound scary, but it is quite simple and minimalistic once you get it done right. You could check resulting code files here:</p><ul><li><a href="https://github.com/KonstantinTomashevich/Emergence/blob/72ff166/Library/Public/Celerity/Extension/Transform/Celerity/Transform/Transform3dComponent.hpp">Transform3dComponent header file.</a><li><a href="https://github.com/KonstantinTomashevich/Emergence/blob/72ff166/Library/Public/Celerity/Extension/Transform/Celerity/Transform/Transform3dComponent.cpp">Transform3dComponent object file.</a><li><a href="https://github.com/KonstantinTomashevich/Emergence/blob/72ff166/Library/Public/Celerity/Extension/Transform/Celerity/Transform/Transform3dVisualSync.cpp">Transform3dVisualSynchronizer task implementation.</a></ul><p>Hope you’ve enjoyed reading! :)</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/emergence/'>Emergence</a>, <a href='/categories/development-log/'>Development Log</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/emergence/" class="post-tag no-text-decoration" >Emergence</a> <a href="/tags/gamedev/" class="post-tag no-text-decoration" >GameDev</a> <a href="/tags/math/" class="post-tag no-text-decoration" >Math</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Emergence%3A+Interpolating+transform+-+WHAT+KIND+OF+DEV+ARE+YOU&url=%2Fposts%2FEmergenceInterpolatingTransform%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Emergence%3A+Interpolating+transform+-+WHAT+KIND+OF+DEV+ARE+YOU&u=%2Fposts%2FEmergenceInterpolatingTransform%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2FEmergenceInterpolatingTransform%2F&text=Emergence%3A+Interpolating+transform+-+WHAT+KIND+OF+DEV+ARE+YOU" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Fposts%2FEmergenceInterpolatingTransform%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/EmergenceWhyIsThereNoEntitiesInCelerity/">Emergence: Why is there no entities in Celerity?</a><li><a href="/posts/ArrowToTheKneeEditingUnorderedMultisetItems/">Arrow to the Knee: Editing unordered_multiset items</a><li><a href="/posts/EmergenceInterpolatingTransform/">Emergence: Interpolating transform</a><li><a href="/posts/EmergenceWhat&Why/">Emergence: What & Why?</a><li><a href="/posts/HintGlobalInitializationOrder/">Hint: Global Initialization Order</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/emergence/">Emergence</a> <a class="post-tag" href="/tags/gamedev/">GameDev</a> <a class="post-tag" href="/tags/tutorials/">Tutorials</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/algorithms/">Algorithms</a> <a class="post-tag" href="/tags/arrow-to-the-knee/">Arrow to the Knee</a> <a class="post-tag" href="/tags/cmake/">CMake</a> <a class="post-tag" href="/tags/containers/">Containers</a> <a class="post-tag" href="/tags/math/">Math</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/EmergenceWhat&Why/"><div class="card-body"> <em class="small" data-ts="1655560800" data-df="ll" > Jun 18, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Emergence: What & Why?</h3><div class="text-muted small"><p> I’ve been developing Emergence project for more than a year. Or two years, if you count a previous unfortunate attempt! I’ve decided to finally come out of the shadow and start writing about it. To...</p></div></div></a></div><div class="card"> <a href="/posts/EmergenceWhyIsThereNoEntitiesInCelerity/"><div class="card-body"> <em class="small" data-ts="1655977200" data-df="ll" > Jun 23, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Emergence: Why is there no entities in Celerity?</h3><div class="text-muted small"><p> Entity is the first of the three core principles of ECS design pattern. Nevertheless, I’ve decided that there should be no entities in Emergence ECS-like framework Celerity. I will tell you how I’v...</p></div></div></a></div><div class="card"> <a href="/posts/EmergenceReflection/"><div class="card-body"> <em class="small" data-ts="1658573400" data-df="ll" > Jul 23, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Emergence: Reflection</h3><div class="text-muted small"><p> Reflection system is an important part of every engine, but there is no standard solution for that in C++: there are lots of libraries with their pros and cons. I’ve decided to write my own reflec...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/EmergenceWhyIsThereNoEntitiesInCelerity/" class="btn btn-outline-primary" prompt="Older"><p>Emergence: Why is there no entities in Celerity?</p></a> <a href="/posts/TutorialLinkTimePolymorphismBasics/" class="btn btn-outline-primary" prompt="Newer"><p>Tutorial: Link-time polymorphism basics</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "WhatKindOfDevAreYou/WhatKindOfDevAreYou.github.io", "data-repo-id": "R_kgDOHhaiVA", "data-category": "GitHub Pages Comments", "data-category-id": "DIC_kwDOHhaiVM4CPv5_", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/KonstantinTomashevich">Konstantin Tomashevich</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/emergence/">Emergence</a> <a class="post-tag" href="/tags/gamedev/">GameDev</a> <a class="post-tag" href="/tags/tutorials/">Tutorials</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/algorithms/">Algorithms</a> <a class="post-tag" href="/tags/arrow-to-the-knee/">Arrow to the Knee</a> <a class="post-tag" href="/tags/cmake/">CMake</a> <a class="post-tag" href="/tags/containers/">Containers</a> <a class="post-tag" href="/tags/math/">Math</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>

<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Emergence: Reflection" /><meta property="og:locale" content="en" /><meta name="description" content="Reflection system is an important part of every engine, but there is no standard solution for that in C++: there are lots of libraries with their pros and cons. I’ve decided to write my own reflection for Emergence and I will describe it in this post." /><meta property="og:description" content="Reflection system is an important part of every engine, but there is no standard solution for that in C++: there are lots of libraries with their pros and cons. I’ve decided to write my own reflection for Emergence and I will describe it in this post." /><link rel="canonical" href="/posts/EmergenceReflection/" /><meta property="og:url" content="/posts/EmergenceReflection/" /><meta property="og:site_name" content="WHAT KIND OF DEV ARE YOU" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-07-23T13:50:00+03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Emergence: Reflection" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-07-23T13:50:00+03:00","datePublished":"2022-07-23T13:50:00+03:00","description":"Reflection system is an important part of every engine, but there is no standard solution for that in C++: there are lots of libraries with their pros and cons. I’ve decided to write my own reflection for Emergence and I will describe it in this post.","headline":"Emergence: Reflection","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/EmergenceReflection/"},"url":"/posts/EmergenceReflection/"}</script><title>Emergence: Reflection | WHAT KIND OF DEV ARE YOU</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="WHAT KIND OF DEV ARE YOU"><meta name="application-name" content="WHAT KIND OF DEV ARE YOU"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">WHAT KIND OF DEV ARE YOU</a></div><div class="site-subtitle font-italic">Personal blog above Game Development and related things</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/KonstantinTomashevich" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://t.me/WhatKindOfDevAreYou" aria-label="telegram" target="_blank" rel="noopener"> <i class="fab fa-telegram"></i> </a> <a href="https://t.me/KonstantinTomashevich" aria-label="telegram" target="_blank" rel="noopener"> <i class="fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/in/konstantin-tomashevich-1881aa152/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Emergence: Reflection</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Emergence: Reflection</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1658573400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 23, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/KonstantinTomashevich">Konstantin Tomashevich</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2947 words"> <em>16 min</em> read</span></div></div></div><div class="post-content"><p>Reflection system is an important part of every engine, but there is no standard solution for that in C++: there are lots of libraries with their pros and cons. I’ve decided to write my own reflection for <a href="https://github.com/KonstantinTomashevich/Emergence">Emergence</a> and I will describe it in this post.</p><h3 id="motivation"><span class="mr-2">Motivation</span><a href="#motivation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>It’s impossible to underestimate how useful good reflection system could be: reflection provides wide variety of tools to make code more flexible, robust, elegant and give it some kind of consciousness. But everything comes with a price: reflection might consume a lot of compile time or be rather slow from performance point of view. Therefore I’ve decided to write my own reflection system that is fine-tuned for <a href="https://github.com/KonstantinTomashevich/Emergence">Emergence</a> project needs and is as lightweight as possible.</p><p>When you’re starting to design your own solution it is crucial to define usage scope and examine expected use cases. Otherwise, it is easy to build complex orbital gun with lots of unusable features. For the <a href="https://github.com/KonstantinTomashevich/Emergence">Emergence</a> main usage scope of reflection is managing data: observing field values, changing them or iterating through the whole data structure. There are some examples:</p><ul><li>Indices observe specified fields and process their values changes.<li><a href="https://github.com/KonstantinTomashevich/Emergence/tree/a275a21/Library/Public/Celerity">Celerity</a> events use reflection to extract and copy useful data from objects.<li>Serialization library, which is not finished yet, uses reflection to iterate over data structure to serialize or deserialize it.<li>Reflection is used as a high-level parameter for generic pipeline tasks like <a href="https://github.com/KonstantinTomashevich/Emergence/tree/a275a21/Library/Public/Celerity/Extension/Assembly">Celerity::Assembly</a> extension.</ul><p>After examination of these use cases I’ve decided that:</p><ul><li>There is no need to reflect methods: reflecting fields, no-argument constructor and destructor is enough.<li>We can focus on <a href="https://en.cppreference.com/w/cpp/named_req/StandardLayoutType">standard layout types</a> and ignore other types because in the most cases data is stored in such types.<li>Reflection must provide API for O(1) field access: no search, no nested hierarchy traversing.<li>Reflection headers must be lightweight and template-free for optimal compile time.<li>Reflection must be aware of unions and inplace vectors: otherwise iteration would show irrelevant fields.</ul><p>Thats how the idea of <a href="https://github.com/KonstantinTomashevich/Emergence/tree/a275a21/Service/StandardLayoutMapping">StandardLayoutMapping service</a> was born.</p><h3 id="features-overview"><span class="mr-2">Features overview</span><a href="#features-overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Before diving into details it is good to inform the reader what my reflection system can and cannot achieve. Let’s start from the features:</p><ul><li>Lightweight field-only reflection for <a href="https://en.cppreference.com/w/cpp/named_req/StandardLayoutType">standard layout types</a>.<li>Field identifiers and handles provide O(1) access to field info.<li>Conditional field iteration is aware of unions and inplace vectors in the context of given data object.<li>One-bit flags are supported.<li>Field identifiers are stable and can be used for serialization.<li>Patches provide generic way to apply changes to an object.</ul><p>But there are some limitations too:</p><ul><li>Only <a href="https://en.cppreference.com/w/cpp/named_req/StandardLayoutType">standard layout types</a> are supported.<li>Method registration is not supported.<li>Field meta registration is not supported.</ul><p>I would like to add my personal opinion about field meta, because it’s not so difficult to implement, but nevertheless I’ve decided to omit this feature. The thing is that usually meta adds unnecessary coupling between data and its usage. It looks very convenient and useful at the first glance, but than you might end up with transform implementation that depends on networking implementation in order to add networking-related meta. Or all meta types might be declared as one big heap and included everywhere. But that is not the biggest problem: what if you need different networking or interpolation or some other meta-based settings for shared data type in two different projects? For example, one project needs to replicate scale and the other one doesn’t. So I’ve decided to avoid using meta at all in order to prevent such problems from appearing.</p><h3 id="terms"><span class="mr-2">Terms</span><a href="#terms" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><code class="language-plaintext highlighter-rouge">Mapping</code> – structure than contains all the info about registered data type.<li><code class="language-plaintext highlighter-rouge">MappingBuilder</code> – special object that provides API for <code class="language-plaintext highlighter-rouge">Mapping</code> creation.<li><code class="language-plaintext highlighter-rouge">Field</code> – handle to the information about one concrete field, belongs to <code class="language-plaintext highlighter-rouge">Mapping</code>.<li><code class="language-plaintext highlighter-rouge">FieldId</code> – special id that is unique in context of <code class="language-plaintext highlighter-rouge">Mapping</code> and allows to get <code class="language-plaintext highlighter-rouge">Field</code> in O(1).<li><code class="language-plaintext highlighter-rouge">Patch</code> – archive of changes, linked to <code class="language-plaintext highlighter-rouge">Mapping</code>, that can be applied to an arbitrary object.<li><code class="language-plaintext highlighter-rouge">PatchBuilder</code> – special object that provides API for <code class="language-plaintext highlighter-rouge">Patch</code> creation.</ul><h3 id="registering-types"><span class="mr-2">Registering types</span><a href="#registering-types" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Let’s explore how type registration works in <a href="https://github.com/KonstantinTomashevich/Emergence">Emergence</a>.</p><p>Actually, there is two registration APIs: verbose core API that is represented by <code class="language-plaintext highlighter-rouge">MappingBuilder</code> class and more user-friendly macro-based approach from <code class="language-plaintext highlighter-rouge">MappingRegistration</code> header. The first one is a basic API that allows user to register types whatever way user wants. The second one is built on top of the first one and represents the approach <a href="https://github.com/KonstantinTomashevich/Emergence">Emergence</a> uses to register types. Choice to have both the verbose basic approach and the simplified macro approach was made in order to achieve flexibility: if user is satisfied with macro-based approach, he can use this approach, otherwise it is possible to implement custom registration approach which will still produce compatible results.</p><p><code class="language-plaintext highlighter-rouge">MappingBuilder</code> is essentially an implementation of classic Builder pattern for <code class="language-plaintext highlighter-rouge">Mapping</code>: it encapsulates registration process and ensures that all <code class="language-plaintext highlighter-rouge">Mapping</code> instances are finished and ready to use. Registration through <code class="language-plaintext highlighter-rouge">MappingBuilder</code> API is quite simple, but verbose. It looks like this:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">MappingBuilder</span> <span class="n">builder</span><span class="p">.</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Begin</span> <span class="p">(</span><span class="s">"MyComponent"</span><span class="n">_us</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">MyComponent</span><span class="p">),</span> <span class="k">alignof</span> <span class="p">(</span><span class="n">MyComponent</span><span class="p">));</span>
<span class="n">builder</span><span class="p">.</span><span class="n">SetConstructor</span> <span class="p">(...);</span>
<span class="n">builder</span><span class="p">.</span><span class="n">SetDestructor</span> <span class="p">(...);</span>

<span class="c1">// ...</span>
<span class="n">FieldId</span> <span class="n">fieldA</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">RegisterInt16</span> <span class="p">(</span><span class="s">"a"</span><span class="n">_us</span><span class="p">,</span> <span class="n">offsetof</span> <span class="p">(</span><span class="n">MyComponent</span><span class="p">,</span> <span class="n">a</span><span class="p">));</span>
<span class="n">FieldId</span> <span class="n">fieldB</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">RegisterFloat</span> <span class="p">(</span><span class="s">"b"</span><span class="n">_us</span><span class="p">,</span> <span class="n">offsetof</span> <span class="p">(</span><span class="n">MyComponent</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
<span class="n">FieldId</span> <span class="n">fieldC</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">RegisterNestedObject</span> <span class="p">(</span><span class="s">"c"</span><span class="n">_us</span><span class="p">,</span> <span class="n">offsetof</span> <span class="p">(</span><span class="n">MyComponent</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">typeCMapping</span><span class="p">);</span>
<span class="c1">// ...</span>

<span class="n">Mapping</span> <span class="n">typeMyComponentMapping</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">End</span> <span class="p">();</span>
</pre></table></code></div></div><p>As you can see, this approach only cares about putting fields into <code class="language-plaintext highlighter-rouge">Mapping</code>, but not about storing <code class="language-plaintext highlighter-rouge">Mapping</code>s and <code class="language-plaintext highlighter-rouge">FieldId</code>s. Also, it forces us to duplicate field names and types. Obviously, this API wasn’t designed for direct use – it was designed to be the simplest base API for building custom better APIs. And <a href="https://github.com/KonstantinTomashevich/Emergence">Emergence</a> offers such API out of the box in <code class="language-plaintext highlighter-rouge">MappingRegistration</code> header.</p><p>In <code class="language-plaintext highlighter-rouge">MappingRegistration</code> approach every type stores information about itself in special <code class="language-plaintext highlighter-rouge">Reflection</code> structure and provides instance of this structure through static <code class="language-plaintext highlighter-rouge">Reflect</code> method, like this:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">MyComponent</span> <span class="k">final</span>
<span class="p">{</span>
    <span class="c1">// Fields of our component.</span>
    <span class="kt">int16_t</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>
    <span class="n">SomeClass</span> <span class="n">c</span><span class="p">;</span>

    <span class="c1">// Reflection structure that lists all reflected</span>
    <span class="c1">// information about this type.</span>
    <span class="k">struct</span> <span class="nc">Reflection</span> <span class="k">final</span>
    <span class="p">{</span>
        <span class="n">FieldId</span> <span class="n">a</span><span class="p">;</span>
        <span class="n">FieldId</span> <span class="n">b</span><span class="p">;</span>
        <span class="n">FieldId</span> <span class="n">c</span><span class="p">;</span>
        <span class="n">Mapping</span> <span class="n">mapping</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="c1">// Static method for getting reflection info.</span>
    <span class="k">static</span> <span class="k">const</span> <span class="n">Reflection</span> <span class="o">&amp;</span><span class="n">Reflect</span> <span class="p">()</span> <span class="k">noexcept</span><span class="p">;</span>
<span class="p">};</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">Reflection</code> structure defines how we store reflection data. We still need to duplicate field names: it’s far from ideal, but I wasn’t able to come up with any solution that avoids it entirely. The best thing about this technique of storing reflection data is that it provides universal form of access to this data making registration very easy:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">const</span> <span class="n">MyComponent</span><span class="o">::</span><span class="n">Reflection</span> <span class="o">&amp;</span><span class="n">MyComponent</span><span class="o">::</span><span class="n">Reflect</span> <span class="p">()</span> <span class="k">noexcept</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">Reflection</span> <span class="n">reflection</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">()</span>
    <span class="p">{</span>
        <span class="n">EMERGENCE_MAPPING_REGISTRATION_BEGIN</span> <span class="p">(</span><span class="n">MyComponent</span><span class="p">);</span>
        <span class="n">EMERGENCE_MAPPING_REGISTER_REGULAR</span> <span class="p">(</span><span class="n">a</span><span class="p">);</span>
        <span class="n">EMERGENCE_MAPPING_REGISTER_REGULAR</span> <span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">EMERGENCE_MAPPING_REGISTER_REGULAR</span> <span class="p">(</span><span class="n">c</span><span class="p">);</span>
        <span class="n">EMERGENCE_MAPPING_REGISTRATION_END</span> <span class="p">();</span>
    <span class="p">}();</span>

    <span class="k">return</span> <span class="n">reflection</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>As you can see, everything about registered fields is deduced automatically and we’re not duplicating anything now! It’s neat, isn’t it?</p><p>You can also notice that macro is named <code class="language-plaintext highlighter-rouge">EMERGENCE_MAPPING_REGISTER_REGULAR</code> instead of just <code class="language-plaintext highlighter-rouge">EMERGENCE_MAPPING_REGISTER</code>. It is called like that because we have two “irregular” field archetypes: inplace strings and plain blocks of memory. Right now we can not safely deduce whether given field is inplace string or plain block, therefore we’re registering them though separate macros: <code class="language-plaintext highlighter-rouge">EMERGENCE_MAPPING_REGISTER_BLOCK</code> and <code class="language-plaintext highlighter-rouge">EMERGENCE_MAPPING_REGISTER_STRING</code>.</p><p>But what about arrays? Thankfully, there is solution for that too!</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="c1">// Header.</span>

<span class="k">struct</span> <span class="nc">ArrayComponent</span> <span class="k">final</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="mi">32u</span><span class="o">&gt;</span> <span class="n">ints</span><span class="p">;</span>

    <span class="k">struct</span> <span class="nc">Reflection</span> <span class="k">final</span>
    <span class="p">{</span>
        <span class="c1">// We declare array of fields inside our reflection structure.</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">FieldId</span><span class="p">,</span> <span class="mi">32u</span><span class="o">&gt;</span> <span class="n">ints</span><span class="p">;</span>
        <span class="n">Mapping</span> <span class="n">mapping</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="k">static</span> <span class="k">const</span> <span class="n">Reflection</span> <span class="o">&amp;</span><span class="n">Reflect</span> <span class="p">()</span> <span class="k">noexcept</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Object.</span>

<span class="k">const</span> <span class="n">ArrayComponent</span><span class="o">::</span><span class="n">Reflection</span> <span class="o">&amp;</span><span class="n">ArrayComponent</span><span class="o">::</span><span class="n">Reflect</span> <span class="p">()</span> <span class="k">noexcept</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">Reflection</span> <span class="n">reflection</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">()</span>
    <span class="p">{</span>
        <span class="n">EMERGENCE_MAPPING_REGISTRATION_BEGIN</span> <span class="p">(</span><span class="n">ArrayComponent</span><span class="p">);</span>
        <span class="n">EMERGENCE_MAPPING_REGISTER_REGULAR_ARRAY</span> <span class="p">(</span><span class="n">ints</span><span class="p">);</span>
        <span class="n">EMERGENCE_MAPPING_REGISTRATION_END</span> <span class="p">();</span>
    <span class="p">}();</span>

    <span class="k">return</span> <span class="n">reflection</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="field-projection"><span class="mr-2">Field projection</span><a href="#field-projection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Imagine that we have structure that contains other structures as fields:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">Inner</span> <span class="k">final</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>

    <span class="c1">// ... Reflection ...</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">Complex</span> <span class="k">final</span>
<span class="p">{</span>
    <span class="n">Inner</span> <span class="n">a</span><span class="p">;</span>
    <span class="n">Inner</span> <span class="n">b</span><span class="p">;</span>
    <span class="n">Inner</span> <span class="n">c</span><span class="p">;</span>

    <span class="c1">// ... Reflection ...</span>
<span class="p">};</span>
</pre></table></code></div></div><p>Accessing field <code class="language-plaintext highlighter-rouge">x</code> of <code class="language-plaintext highlighter-rouge">Inner</code> by <code class="language-plaintext highlighter-rouge">FieldId</code> in O(1) looks trivial: we can just store fields in vector. The same goes for field <code class="language-plaintext highlighter-rouge">b</code> of <code class="language-plaintext highlighter-rouge">Complex</code>. But what about field <code class="language-plaintext highlighter-rouge">x</code> of field <code class="language-plaintext highlighter-rouge">c</code> of <code class="language-plaintext highlighter-rouge">Complex</code>? We still want to access it in O(1), but there is no trivial way to do it.</p><p>Technique to solve this issue is called field projection: if <code class="language-plaintext highlighter-rouge">x</code> is field of <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">a</code> is field of <code class="language-plaintext highlighter-rouge">n</code>, then <code class="language-plaintext highlighter-rouge">a.x</code> is a field of <code class="language-plaintext highlighter-rouge">n</code> too. Therefore, our <code class="language-plaintext highlighter-rouge">Complex</code> structure has whole bunch of fields after projection: <code class="language-plaintext highlighter-rouge">a</code>, <code class="language-plaintext highlighter-rouge">a.x</code>, <code class="language-plaintext highlighter-rouge">a.y</code>, <code class="language-plaintext highlighter-rouge">b</code>, <code class="language-plaintext highlighter-rouge">b.x</code>, <code class="language-plaintext highlighter-rouge">b.y</code>, <code class="language-plaintext highlighter-rouge">c</code>, <code class="language-plaintext highlighter-rouge">c.x</code> and <code class="language-plaintext highlighter-rouge">c.y</code>. In order to make this technique mathematically complete we also need to define projection function: <code class="language-plaintext highlighter-rouge">FieldId Project (FieldId rootObjectField, FieldId nestedObjectField)</code>. For example, <code class="language-plaintext highlighter-rouge">FieldId</code> of <code class="language-plaintext highlighter-rouge">a.x</code> is equal to <code class="language-plaintext highlighter-rouge">Project (Complex::Reflect ().a, Inner::Reflect ().x)</code>. As these projected ids are stable we can safely cache them and pass as parameters whenever we need to. In <a href="https://github.com/KonstantinTomashevich/Emergence">Emergence</a> this function is implemented as <code class="language-plaintext highlighter-rouge">Emergence::StandardLayout::ProjectNestedField</code> and is actually just a sum of <code class="language-plaintext highlighter-rouge">rootObjectField</code> and <code class="language-plaintext highlighter-rouge">nestedObjectField</code>! We are able to make it that simple because we are doing projecting right after structure field registration.</p><p>Like any other solution, field projection technique has its pros and cons.</p><p>Pros:</p><ul><li>It provides O(1) access to any field of <a href="https://en.cppreference.com/w/cpp/named_req/StandardLayoutType">standard layout type</a>.<li>It makes algorithms that make use of linearized structure data, for example binary serialization, much easier to implement, because projection automatically makes reflection data linear.</ul><p>Cons:</p><ul><li>It uses lots of memory because of field info duplication: only offsets and ids are changed during projection process, but we need to duplicate whole infos.<li>It makes algorithms that make use of tree-like structure data, for example YAML serialization, a bit more difficult to implement, because they need to skip projected fields everywhere.</ul><p>For <a href="https://github.com/KonstantinTomashevich/Emergence">Emergence</a>, O(1) access to any field was the main reason to stick to this technique: reflection data is used extensively by storage management logic, for example record indexing, therefore reflection access speed defines how effective storage management is.</p><h3 id="conditional-field-iteration"><span class="mr-2">Conditional field iteration</span><a href="#conditional-field-iteration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>It is important to provide user with API that allows to iterate over contextually relevant fields. For example, let’s take a look at that structure:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">CollisionGeometry</span> <span class="k">final</span>
<span class="p">{</span>
    <span class="n">CollisionGeometryType</span> <span class="n">type</span><span class="p">;</span>
    <span class="k">union</span>
    <span class="p">{</span>
        <span class="n">Math</span><span class="o">::</span><span class="n">Vector3f</span> <span class="n">boxHalfExtents</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">sphereRadius</span><span class="p">;</span>
        <span class="k">struct</span>
        <span class="p">{</span>
            <span class="kt">float</span> <span class="n">capsuleRadius</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">capsuleHalfHeight</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>

    <span class="c1">// ... Reflection ...</span>
<span class="p">};</span>
</pre></table></code></div></div><p>Technically it has 5 fields, but not more than 3 fields are contextually relevant at the same time because all fields except one are inside union. For example, for spheres only <code class="language-plaintext highlighter-rouge">type</code> and <code class="language-plaintext highlighter-rouge">sphereRadius</code> fields are relevant. If we’re using reflection to serialize object or log it somewhere, we need to skip these irrelevant fields. The same thing is true for inplace vectors: if vector can hold up to 6 elements, but holds only 2 right now, we should not iterate over garbage memory, stored in last 4 elements.</p><p>At first, I though that unions and inplace vectors are different cases and should be handled in a different way, but then I came up with the idea of conditional field iteration: union switch value or count of elements is just an argument to conditional expression that decides whether field is visible or not in the current context. And there is no need to waste memory by attaching condition to every field: we only need to specify intervals where conditions are active. Also, it makes sense to organize conditions as a stack: we are generally adding and removing them while registering fields.</p><p>It all might sound too abstract and high level, so let’s switch to actual examples. This is registration function for our <code class="language-plaintext highlighter-rouge">CollisionGeometry</code>:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="k">const</span> <span class="n">CollisionGeometry</span><span class="o">::</span><span class="n">Reflection</span> <span class="o">&amp;</span><span class="n">CollisionGeometry</span><span class="o">::</span><span class="n">Reflect</span> <span class="p">()</span> <span class="k">noexcept</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">Reflection</span> <span class="n">reflection</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">()</span>
    <span class="p">{</span>
        <span class="n">EMERGENCE_MAPPING_REGISTRATION_BEGIN</span> <span class="p">(</span><span class="n">CollisionGeometry</span><span class="p">);</span>
        <span class="n">EMERGENCE_MAPPING_REGISTER_REGULAR</span> <span class="p">(</span><span class="n">type</span><span class="p">);</span>

        <span class="n">EMERGENCE_MAPPING_UNION_VARIANT_BEGIN</span> <span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mi">0u</span><span class="p">);</span>
        <span class="n">EMERGENCE_MAPPING_REGISTER_REGULAR</span> <span class="p">(</span><span class="n">boxHalfExtents</span><span class="p">);</span>
        <span class="n">EMERGENCE_MAPPING_UNION_VARIANT_END</span> <span class="p">();</span>

        <span class="n">EMERGENCE_MAPPING_UNION_VARIANT_BEGIN</span> <span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mi">1u</span><span class="p">);</span>
        <span class="n">EMERGENCE_MAPPING_REGISTER_REGULAR</span> <span class="p">(</span><span class="n">sphereRadius</span><span class="p">);</span>
        <span class="n">EMERGENCE_MAPPING_UNION_VARIANT_END</span> <span class="p">();</span>

        <span class="n">EMERGENCE_MAPPING_UNION_VARIANT_BEGIN</span> <span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mi">2u</span><span class="p">);</span>
        <span class="n">EMERGENCE_MAPPING_REGISTER_REGULAR</span> <span class="p">(</span><span class="n">capsuleRadius</span><span class="p">);</span>
        <span class="n">EMERGENCE_MAPPING_REGISTER_REGULAR</span> <span class="p">(</span><span class="n">capsuleHalfHeight</span><span class="p">);</span>
        <span class="n">EMERGENCE_MAPPING_UNION_VARIANT_END</span> <span class="p">();</span>

        <span class="n">EMERGENCE_MAPPING_REGISTRATION_END</span> <span class="p">();</span>
    <span class="p">}();</span>

    <span class="k">return</span> <span class="n">reflection</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>As you can see, there is nothing about conditions yet: <code class="language-plaintext highlighter-rouge">MappingRegistration</code> hides them under macros for readability. But what is hidden under <code class="language-plaintext highlighter-rouge">EMERGENCE_MAPPING_UNION_VARIANT_BEGIN</code> and <code class="language-plaintext highlighter-rouge">EMERGENCE_MAPPING_UNION_VARIANT_END</code> macros?</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="cp">#define EMERGENCE_MAPPING_UNION_VARIANT_BEGIN(_selectorField, _switchValue)                                            \
    builder.PushVisibilityCondition (reflectionData._selectorField,                                                    \
                                     Emergence::StandardLayout::ConditionalOperation::EQUAL, _switchValue)
</span>
<span class="cp">#define EMERGENCE_MAPPING_UNION_VARIANT_END() builder.PopVisibilityCondition ()
</span></pre></table></code></div></div><p>These macros are just operating with conditions through <code class="language-plaintext highlighter-rouge">MappingBuilder</code> interface. When union begins, we’re pushing condition that says: fields below are visible only when <code class="language-plaintext highlighter-rouge">_selectorField</code> is equal to <code class="language-plaintext highlighter-rouge">_switchValue</code>. And when union ends we’re just popping this condition out. There are also other conditional operations, for example inplace vector registration makes use of <code class="language-plaintext highlighter-rouge">&gt;</code> (see <code class="language-plaintext highlighter-rouge">EMERGENCE_MAPPING_REGISTER_REGULAR_VECTOR</code> macro):</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">builder</span><span class="p">.</span><span class="n">PushVisibilityCondition</span> <span class="p">(</span><span class="n">_sizeField</span><span class="p">,</span> <span class="n">ConditionalOperation</span><span class="o">::</span><span class="n">GREATER</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
</pre></table></code></div></div><p>This condition says that fields below should be visible only when vector size aka <code class="language-plaintext highlighter-rouge">_sizeField</code> is greater than element index. Just like that: nothing less, nothing more. Simplicity of this technique makes it very flexible: it is not just for unions and inplace vectors, it can be used anywhere if user needs it.</p><p>Of course, conditional iteration is less performance-friendly that plain iteration, therefore <code class="language-plaintext highlighter-rouge">Mapping</code> has two iteration options: <code class="language-plaintext highlighter-rouge">Begin</code>/<code class="language-plaintext highlighter-rouge">End</code> for non-conditional iteration and <code class="language-plaintext highlighter-rouge">BeginConditional</code>/<code class="language-plaintext highlighter-rouge">EndConditional</code> for conditional iteration. You can use conditional iteration just like the usual one:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">_mapping</span><span class="p">.</span><span class="n">BeginConditional</span> <span class="p">(</span><span class="n">_object</span><span class="p">),</span> <span class="n">end</span> <span class="o">=</span> <span class="n">_mapping</span><span class="p">.</span><span class="n">EndConditional</span> <span class="p">();</span> 
     <span class="n">iterator</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="o">++</span><span class="n">iterator</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">StandardLayout</span><span class="o">::</span><span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="o">*</span><span class="n">iterator</span><span class="p">;</span>
    <span class="c1">/// ...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>There is one important thing about conditional iteration performance: you might think that it is very slow due to condition stack operations – stack push/pops, memory allocation for that and so on. But it is actually not true! Because push/pop order is always the same, we can get rid of stack operations during conditional iteration by baking the operations during type registration. I will not dive into details of this algorithm here, but keep in mind: conditional iteration is not as slow as you might think.</p><h3 id="patches"><span class="mr-2">Patches</span><a href="#patches" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Sometimes it is useful to store difference between two possible states of an object. For example, it can be used for prefab system to apply prefab values to freshly constructed objects. <a href="https://github.com/KonstantinTomashevich/Emergence">Emergence</a> supports this through patches feature: at any moment user can create <code class="language-plaintext highlighter-rouge">Patch</code> using <code class="language-plaintext highlighter-rouge">PatchBuilder</code> and then apply this <code class="language-plaintext highlighter-rouge">Patch</code> whenever it is needed.</p><p>There is two ways to create a patch. First one is to manually list all the differences like that:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">PatchBuilder</span> <span class="n">builder</span><span class="p">;</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Begin</span> <span class="p">(</span><span class="n">Player</span><span class="o">::</span><span class="n">Reflect</span> <span class="p">().</span><span class="n">mapping</span><span class="p">);</span>
<span class="n">builder</span><span class="p">.</span><span class="n">SetBit</span> <span class="p">(</span><span class="n">Player</span><span class="o">::</span><span class="n">Reflect</span> <span class="p">().</span><span class="n">alive</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="n">builder</span><span class="p">.</span><span class="n">SetBit</span> <span class="p">(</span><span class="n">Player</span><span class="o">::</span><span class="n">Reflect</span> <span class="p">().</span><span class="n">poisoned</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="n">Patch</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">End</span> <span class="p">();</span>
</pre></table></code></div></div><p>The second one is much simpler: it automatically creates patch from difference between two objects. For example:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">Player</span> <span class="n">initial</span><span class="p">;</span>
<span class="n">Player</span> <span class="n">other</span> <span class="o">=</span> <span class="n">initial</span><span class="p">;</span>
<span class="n">other</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="n">Player</span><span class="o">::</span><span class="n">ALIVE_FLAG_OFFSET</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="n">Player</span><span class="o">::</span><span class="n">POISONED_FLAG_OFFSET</span><span class="p">);</span>

<span class="n">Patch</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">PatchBuilder</span><span class="o">::</span><span class="n">FromDifference</span> <span class="p">(</span><span class="n">Player</span><span class="o">::</span><span class="n">Reflect</span> <span class="p">().</span><span class="n">mapping</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">initial</span><span class="p">);</span>
</pre></table></code></div></div><p>For performance reasons <code class="language-plaintext highlighter-rouge">Patch</code> system has one limitation: it works only with fields that occupy 8 or less bytes of memory, so inplace strings and inplace blocks of memory are ignored. But not unique strings, inplace vectors and nested objects! Thanks to field projection technique inplace vectors and nested objects are analyzed as sets of disconnected fields and therefore are freely processed by <code class="language-plaintext highlighter-rouge">Patch</code>es.</p><p>After creation <code class="language-plaintext highlighter-rouge">Patch</code>es can be easily applied to any object of target type:</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">patch</span><span class="p">.</span><span class="n">Apply</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">object</span><span class="p">);</span>
</pre></table></code></div></div><p>Just like <code class="language-plaintext highlighter-rouge">Mapping</code>s, <code class="language-plaintext highlighter-rouge">Patch</code>es can be moved, copied and stored anywhere you need.</p><h3 id="implementation-details"><span class="mr-2">Implementation details</span><a href="#implementation-details" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="https://github.com/KonstantinTomashevich/Emergence">Emergence</a> reflection system was implemented with memory usage and cache coherency in mind. All internal data is stored as close to each other as possible:</p><ul><li><code class="language-plaintext highlighter-rouge">Mapping</code> with fields is one continuous block of memory: it is reallocated during creation process to ensure that it uses just enough memory to store all the fields and not more. This allows field iteration to be as cache coherent as possible and also makes simultaneous access to multiple fields cache coherent too.<li>Field visibility conditions are stored in special pool in order not to interfere with the field data. In the meantime, pool makes sure that conditions are laid down continuously unless page ends. Therefore condition access during conditional allocation is also cache coherent.<li>Like <code class="language-plaintext highlighter-rouge">Mapping</code>, <code class="language-plaintext highlighter-rouge">Patch</code> is also represented by one continuous block of memory, that is reallocated during creation process. It makes patch application process as cache coherent as possible.</ul><p>Also, both <code class="language-plaintext highlighter-rouge">Mapping</code> and <code class="language-plaintext highlighter-rouge">Patch</code> are actually managed as resource handles, therefore copying a <code class="language-plaintext highlighter-rouge">Mapping</code> or a <code class="language-plaintext highlighter-rouge">Patch</code> does not result in actual data duplication: it only increases resource reference count.</p><h3 id="reflection-usage"><span class="mr-2">Reflection usage</span><a href="#reflection-usage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="https://github.com/KonstantinTomashevich/Emergence/tree/a275a21/Service/StandardLayoutMapping">StandardLayoutMapping service</a> is a backbone of <a href="https://github.com/KonstantinTomashevich/Emergence">Emergence</a> and used almost everywhere. There is a quick summary of what it is used for:</p><ul><li>It powers the <a href="https://github.com/KonstantinTomashevich/Emergence/tree/a275a21/Service/RecordCollection">RecordCollection service</a> by allowing it to use any record field for any index that needs it. Reflection also provides constructors and destructors for the records.<li>It powers the <a href="https://github.com/KonstantinTomashevich/Emergence/tree/a275a21/Service/Warehouse">Warehouse service</a> by providing enough information for prepared query and object storages creation.<li>It provides <a href="https://github.com/KonstantinTomashevich/Emergence/tree/a275a21/Library/Public/Celerity">Celerity library</a> with information for query preparation, event management and pipeline validation.<li>Patches are the backbone of <a href="https://github.com/KonstantinTomashevich/Emergence/tree/a275a21/Library/Public/Celerity/Extension/Assembly">Celerity::Assembly library</a>: they are used to initialize freshly created objects with required data.</ul><p>To summarize, <a href="https://github.com/KonstantinTomashevich/Emergence/tree/a275a21/Service/StandardLayoutMapping">StandardLayoutMapping service</a> is a very important part of <a href="https://github.com/KonstantinTomashevich/Emergence">Emergence</a> project that powers lots of other high level libraries. It was specially designed and optimized for optimal usage inside these libraries.</p><p>Hope you’ve enjoyed reading! If you have any suggestions, feel free to contact me through telegram or email.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/emergence/'>Emergence</a>, <a href='/categories/development-log/'>Development Log</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/emergence/" class="post-tag no-text-decoration" >Emergence</a> <a href="/tags/c/" class="post-tag no-text-decoration" >C++</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Emergence%3A+Reflection+-+WHAT+KIND+OF+DEV+ARE+YOU&url=%2Fposts%2FEmergenceReflection%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Emergence%3A+Reflection+-+WHAT+KIND+OF+DEV+ARE+YOU&u=%2Fposts%2FEmergenceReflection%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2FEmergenceReflection%2F&text=Emergence%3A+Reflection+-+WHAT+KIND+OF+DEV+ARE+YOU" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Fposts%2FEmergenceReflection%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/EmergenceWhyIsThereNoEntitiesInCelerity/">Emergence: Why is there no entities in Celerity?</a><li><a href="/posts/ArrowToTheKneeEditingUnorderedMultisetItems/">Arrow to the Knee: Editing unordered_multiset items</a><li><a href="/posts/EmergenceInterpolatingTransform/">Emergence: Interpolating transform</a><li><a href="/posts/EmergenceWhat&Why/">Emergence: What & Why?</a><li><a href="/posts/HintGlobalInitializationOrder/">Hint: Global Initialization Order</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/emergence/">Emergence</a> <a class="post-tag" href="/tags/gamedev/">GameDev</a> <a class="post-tag" href="/tags/tutorials/">Tutorials</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/algorithms/">Algorithms</a> <a class="post-tag" href="/tags/arrow-to-the-knee/">Arrow to the Knee</a> <a class="post-tag" href="/tags/cmake/">CMake</a> <a class="post-tag" href="/tags/containers/">Containers</a> <a class="post-tag" href="/tags/math/">Math</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/EmergenceWhat&Why/"><div class="card-body"> <em class="small" data-ts="1655560800" data-df="ll" > Jun 18, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Emergence: What & Why?</h3><div class="text-muted small"><p> I’ve been developing Emergence project for more than a year. Or two years, if you count a previous unfortunate attempt! I’ve decided to finally come out of the shadow and start writing about it. To...</p></div></div></a></div><div class="card"> <a href="/posts/EmergenceMemoryManagement/"><div class="card-body"> <em class="small" data-ts="1660026600" data-df="ll" > Aug 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Emergence: Memory management</h3><div class="text-muted small"><p> It is very important to have consistent memory model for your project from the start, because it is almost impossible to change it later. In this post I will talk about Emergence memory management ...</p></div></div></a></div><div class="card"> <a href="/posts/EmergenceWhyIsThereNoEntitiesInCelerity/"><div class="card-body"> <em class="small" data-ts="1655977200" data-df="ll" > Jun 23, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Emergence: Why is there no entities in Celerity?</h3><div class="text-muted small"><p> Entity is the first of the three core principles of ECS design pattern. Nevertheless, I’ve decided that there should be no entities in Emergence ECS-like framework Celerity. I will tell you how I’v...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/TutorialStringInterning/" class="btn btn-outline-primary" prompt="Older"><p>Tutorial: String interning</p></a> <a href="/posts/EmergenceMemoryManagement/" class="btn btn-outline-primary" prompt="Newer"><p>Emergence: Memory management</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "WhatKindOfDevAreYou/WhatKindOfDevAreYou.github.io", "data-repo-id": "R_kgDOHhaiVA", "data-category": "GitHub Pages Comments", "data-category-id": "DIC_kwDOHhaiVM4CPv5_", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/KonstantinTomashevich">Konstantin Tomashevich</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/emergence/">Emergence</a> <a class="post-tag" href="/tags/gamedev/">GameDev</a> <a class="post-tag" href="/tags/tutorials/">Tutorials</a> <a class="post-tag" href="/tags/ecs/">ECS</a> <a class="post-tag" href="/tags/algorithms/">Algorithms</a> <a class="post-tag" href="/tags/arrow-to-the-knee/">Arrow to the Knee</a> <a class="post-tag" href="/tags/cmake/">CMake</a> <a class="post-tag" href="/tags/containers/">Containers</a> <a class="post-tag" href="/tags/math/">Math</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
